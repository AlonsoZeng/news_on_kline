# 政策数据日期修正工具使用说明

## 问题背景

在政策数据抓取过程中，发现数据库中的日期字段存在问题：
- 大部分记录的日期都是抓取当天的日期（如2025-06-17）
- 没有正确提取政策页面中的真实"发布日期"
- 需要统一修正所有政策记录的日期字段

## 解决方案

开发了一套日期修正工具，能够：
1. 访问政策页面URL
2. 智能提取页面中的"发布日期"信息
3. 将日期转换为标准格式（YYYY-MM-DD）
4. 批量更新数据库中的日期字段
5. 支持断点续传和进度保存

## 工具文件说明

### 1. `fix_policy_dates.py` - 基础日期修正工具

**功能**：
- 单次处理指定数量的政策记录
- 从政策页面提取真实发布日期
- 支持多种日期格式识别

**使用方法**：
```bash
# 处理前10条记录（测试用）
python fix_policy_dates.py 10

# 处理前100条记录
python fix_policy_dates.py 100

# 处理所有记录
python fix_policy_dates.py
```

### 2. `batch_fix_dates.py` - 批量处理工具（推荐）

**功能**：
- 支持断点续传
- 进度保存和恢复
- 批量处理所有记录
- 详细的进度报告

**使用方法**：
```bash
# 查看当前进度
python batch_fix_dates.py status

# 开始处理
python batch_fix_dates.py start

# 继续处理（如果中断后）
python batch_fix_dates.py continue

# 重置进度（从头开始）
python batch_fix_dates.py reset

# 交互式运行
python batch_fix_dates.py
```

### 3. `check_date_format.py` - 日期格式检查工具

**功能**：
- 检查数据库中的日期格式
- 统计日期分布情况
- 验证修正效果

**使用方法**：
```bash
python check_date_format.py
```

## 日期提取逻辑

### 1. URL模式匹配
工具首先尝试从URL中提取日期：
- `/2024/06/15/` 格式
- `/2024-06-15` 格式
- `/20240615/` 格式
- `t20240615` 格式
- `content_2024_0615` 格式

### 2. 页面内容解析
如果URL中没有日期，则访问页面内容：
- 查找"发布时间"、"发布日期"等关键词
- 支持中文日期格式（2024年6月15日）
- 支持标准日期格式（2024-06-15）
- 查找特定的HTML元素（.time, .date等）

### 3. 日期验证
- 验证日期的有效性
- 确保日期不是未来日期
- 确保日期在合理范围内（2000年以后）

## 处理结果示例

### 修正前
```
大部分记录的日期: 2025-06-17 (抓取当天)
```

### 修正后
```
2024-08-28: 国务院办公厅关于以高水平开放推动服务贸易高质量发展的意见
2025-05-04: 国务院办公厅关于进一步优化政务服务提升行政效能的指导意见
2025-05-07: 国务院办公厅关于进一步加强困境儿童福利保障工作的意见
2025-06-02: 国务院关于《东莞市国土空间总体规划（2021—2035年）》的批复
2025-06-06: 国务院关于开展第四次全国农业普查的通知
```

## 性能统计

基于测试结果：
- **成功率**: 约90%的记录能够成功提取到真实日期
- **处理速度**: 每条记录约0.3-0.5秒（包含网络请求）
- **错误处理**: 无法提取日期的记录会被跳过，不影响其他记录

## 进度管理

批量处理工具会自动保存进度到 `date_fix_progress.json` 文件：
```json
{
  "last_processed_id": 150,
  "total_updated": 135,
  "total_skipped": 15,
  "total_errors": 0,
  "start_time": "2025-06-17T18:07:42.123456",
  "last_update_time": "2025-06-17T18:15:30.789012"
}
```

## 注意事项

### 1. 网络依赖
- 工具需要访问政策页面URL提取日期
- 确保网络连接稳定
- 部分页面可能访问失败，会自动跳过

### 2. 处理时间
- 全量处理665条记录大约需要5-10分钟
- 每个请求间隔0.3秒，避免对服务器造成压力

### 3. 数据备份
- 建议在大批量处理前备份数据库
- 工具会自动保存进度，支持中断后继续

### 4. 日志记录
- 详细的处理日志保存在 `batch_fix_dates.log`
- 可以查看具体的处理过程和错误信息

## 故障排除

### 1. 网络超时
```
错误: requests.exceptions.Timeout
解决: 工具会自动重试，跳过无法访问的页面
```

### 2. 页面解析失败
```
错误: 无法提取日期
解决: 记录会被跳过，不影响其他处理
```

### 3. 数据库锁定
```
错误: database is locked
解决: 确保没有其他程序在使用数据库
```

## 验证修正效果

处理完成后，可以运行检查工具验证：
```bash
python check_date_format.py
```

查看日期分布是否更加合理，不再集中在某一天。

## 总结

通过这套日期修正工具，可以有效解决政策数据库中日期字段的问题，确保每条政策记录都有准确的发布日期，为后续的数据分析和展示提供可靠的时间基础。

---

**最后更新**: 2025-06-17  
**工具版本**: 1.0  
**适用数据库**: events.db (policy_events表)